$$\begin{aligned}
&\text{问题}\mathcal{S}{:}\text{一场比赛,有两个玩家,每回合玩家1获胜的概率为}p_1\text{,玩家2获胜的概率为}p_2\text{,目}0<p_1+p_2\leq1\text{,其余情况为平局。如果一个玩家累计获胜}n\text{局,那么比赛结} \\
&\text{束。问回合数的期望是多少。其中}n\geq10^6
\end{aligned}$$

很容易想到一个 DP 公式 $dp(i,j)$ 表示玩家 1 胜利 $i$ 场，玩家 2 胜了 $j$ 场，问剩下的回合数的期望。这个 DP 公式的时间复杂度为 $O(n^2)$。我们记 $s=(a,b)$ 为游戏结束的状态，即最终玩家 1 胜了 $a$ 场，玩家 $b$ 胜了 $b$ 场。其中很显然 $a,b$ 屮正好一个数等于 $n$。

好的，现在我们需要计算最终游戏的状态恰好为 $(a,b)$ 的概率是多少，不失一般性，令 $a=n$,可以得到：

$$
p(s=(n,b))=\binom{n+b-1}{n-1}(\frac{p_1}{p_1+p_2})^n(\frac{p_2}{p_1+p_2})^b
$$

接下来我们记 $x$ 为玩家 1 胜利的场次，$y$ 为玩家 2 胜利的场次，$z$ 为平局的场次，则可以发现我们要求的是 $E[x+y+z]$。根据全期望公式可以得到

$$
\begin{gathered}
E[x+y+z] \\
=\sum_{s=(a,b)}E[x+y+z|s=(a,b)]p(s=(a,b)) \\
=\sum_{s=(a,b)}(a+b+E[z|s=(a,b)])p(s=(a,b)) 
\end{gathered}
$$

其中如果我们记 $z_i$ 为第 $i-1$ 次一方胜利后到第 $i$ 次一方胜利前的平局数，则有：

$$
\begin{gathered}
E[z|s=(a,b)] \\
=E[z_1+z_2+\ldots+z_{a+b}|s=(a,b)] \\
(a+b)E[z_i|s=(a,b)]=(a+b)(\frac1{p_1+p_2}-1) 
\end{gathered}
$$


